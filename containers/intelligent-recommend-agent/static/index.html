<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Agent Terminal</title>

    <!-- xterm core -->
    <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css" />
    <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
    <!-- fit addon -->
    <script src="https://unpkg.com/xterm-addon-fit/lib/xterm-addon-fit.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        background: #000;
      }

      /* í™”ë©´ ì „ì²´ë¥¼ í„°ë¯¸ë„ìš© ì»¨í…Œì´ë„ˆë¡œ */
      #terminal-container {
        height: 100vh;
        width: 100vw;
      }

      #terminal {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>

  <body>
    <div id="terminal-container">
      <div id="terminal"></div>
    </div>

    <script>
      const term = new Terminal({
        cursorBlink: true,
        fontSize: 14,
        theme: { background: '#000000', foreground: '#ffffff' }
      });

      // fit addon ë¡œë“œ
      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);

      term.open(document.getElementById('terminal'));
      fitAddon.fit();        // ì²˜ìŒì— í•œ ë²ˆ ë§ì¶°ì£¼ê¸°
      term.focus();
      term.write("ğŸ”— Connecting to agent...\r\n");

      // ì°½ í¬ê¸° ë°”ë€” ë•Œë„ í„°ë¯¸ë„ ë¦¬ì‚¬ì´ì¦ˆ
      window.addEventListener("resize", () => {
        fitAddon.fit();
      });

      // === WebSocket URL ì„¤ì • ===
      let wsUrl;
      if (location.protocol === "https:") {
        wsUrl = "wss://" + location.host + "/ws";
      } else if (location.protocol === "http:") {
        wsUrl = "ws://" + location.host + "/ws";
      } else {
        wsUrl = "ws://localhost:8000/ws";
      }

      const socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        term.write("âœ”ï¸ Connected!\r\n");
        term.write("\r\n");
      };

      socket.onmessage = (ev) => {
        term.write(ev.data.replace(/\n/g, "\r\n"));
      };

      socket.onerror = (err) => {
        term.write("\r\nâŒ WebSocket error\r\n");
        console.error("WS error", err);
        term.write("\r\n");
      };

      socket.onclose = () => {
        term.write("\r\nğŸ”Œ Disconnected\r\n");
        term.write("\r\n");
      };

      // ì—”í„° ì¹  ë•Œ í•œ ì¤„ì”© ì „ì†¡
      let inputBuffer = "";

      term.onData(data => {
        if (socket.readyState !== WebSocket.OPEN) {
          return;
        }

        switch (data) {
          case "\r": // Enter
            const line = inputBuffer;
            socket.send(line);
            term.write("\r\n");
            inputBuffer = "";
            break;

          case "\u007f": // Backspace
            if (inputBuffer.length > 0) {
              inputBuffer = inputBuffer.slice(0, -1);
              term.write("\b \b");
            }
            break;

          default:
            inputBuffer += data;
            term.write(data);
            break;
        }
      });
    </script>
  </body>
</html>